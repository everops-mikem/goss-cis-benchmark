---
# CIS Ubuntu Linux 16.04 LTS Benchmark v2.0.0
# CIS Ubuntu Linux 18.04 LTS Benchmark v2.1.0
# CIS Ubuntu Linux 20.04 LTS Benchmark v1.1.0
#
# 1 Initial Setup
# 1.1.10 /var is a separate partition - level 2 (not implemented)
# 1.1.11 thru 1.1.14 /var/tmp is a separate partition with appropriate options - level 2 (not implemented)
# 1.1.15 /var/logs is a separate partition - level 2 (not implemented)
# 1.1.16 /var/audit is a separate partition - level 2 (not implemented)
# 1.1.17 & 1.1.18 /home is a separate partition with nodev option - level 2 (not implemented)
# 1.1.19 thru 1.1.21 set appropriate options on removable media partitions (not implemented)
# 1.2 Configure Software Updates - manual site-local configuration verification (not implemented)
# 1.4.2 Ensure bootloader password is set (not implemented)
# 1.4.4 Ensure authentication required for single user mode (not implemented)
# 1.6.1.4 Ensure all AppArmor Profiles are enforcing - level 2 (not implemented)

command:
  {{- range $k,$v := dict "cramfs" "1.1.1.1" "freevxfs" "1.1.1.2" "jffs" "1.1.1.3" "hfs" "1.1.1.4" "hfsplus" "1.1.1.5" "udf" "1.1.1.7" "usb-storage" "1.1.24"}}
  modprobe -n -v {{$k}} 2>&1 | grep -E 'Module {{$k}} not found|install\s+/bin/(true|false)':
    exit-status: 0
    title: '{{$v}} Ensure mounting of {{$k}} filesystems is disabled'
    meta:
      item:
        - '{{$v}}'
      level: 1
  lsmod | grep {{$k}}:
    exit-status: 1
    title: '{{$v}} Ensure mounting of {{$k}} filesystems is disabled'
    meta:
      item:
        - '{{$v}}'
      level: 1
  {{end}}

  {{- range $k,$v := dict "squashfs" "1.1.1.6"}}
  modprobe -n -v {{$k}} 2>&1 | grep -E 'Module {{$k}} not found|install\s+/bin/(true|false)':
    exit-status: 0
    title: '{{$v}} Ensure mounting of {{$k}} filesystems is disabled'
    meta:
      item:
        - '{{$v}}'
      level: 2
  lsmod | grep {{$k}}:
    exit-status: 1
    title: '{{$v}} Ensure mounting of {{$k}} filesystems is disabled'
    meta:
      item:
        - '{{$v}}'
      level: 2
  {{end}}

  # Requires goss is executed as root user
  df --local -P -x tmpfs -x devtmpfs -x overlay -x overlay2 | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -type d \( -perm -0002 -a ! -perm -1000 \) 2>/dev/null:
    exit-status: 0
    stdout: [ ]
    timeout: 1000000
    title: '1.1.22 Ensure sticky bit is set on all world-writable directories'
    meta:
      item:
        - '1.1.22'
      level: 1

  journalctl -k | egrep "NX.*protection:.*active":
    exit-status: 0
    title: '1.5.1 Ensure XD/NX support is enabled'
    meta:
      item:
        - '1.5.1'
      level: 1

  grep "^\s*linux" /boot/grub/grub.cfg | grep -v "apparmor=1":
    exit-status: 1
    stdout: []
    title: '1.6.1.2 Ensure AppArmor is enabled in the bootloader configuration'
    meta:
      item:
        - '1.6.1.2'
      level: 1
  grep "^\s*linux" /boot/grub/grub.cfg | grep -v "security=apparmor":
    exit-status: 1
    stdout: []
    title: '1.6.1.2 Ensure AppArmor is enabled in the bootloader configuration'
    meta:
      item:
        - '1.6.1.2'
      level: 1

  test $(expr `apparmor_status --enforced` + `apparmor_status --complaining`) = $(apparmor_status --profiled):
    exit-status: 0
    title: '1.6.1.3 Ensure all AppArmor Profiles are in enforce or complain mode'
    meta:
      item:
        - '1.6.1.3'
      level: 1

  /usr/lib/update-notifier/apt-check:
    exit-status: 0
    stdout:
      - ""
    title: '1.9 Ensure updates, patches, and additional security software are installed'
    meta:
      item:
        - '1.9'
      level: 1

mount:
  /tmp:
    exists: true
    opts:
      - nodev
      - nosuid
      - noexec
    title: '1.1.2 thru 1.1.5 Ensure /tmp is configured with appropriate options'
    meta:
      item:
        - '1.1.2'
        - '1.1.3'
        - '1.1.4'
        - '1.1.5'
      level: 1
  /dev/shm:
    exists: true
    opts:
      - nodev
      - nosuid
      - noexec
    title: '1.1.6 thru 1.1.9 Ensure /dev/shm is configured with appropriate options'
    meta:
      item:
        - '1.1.6'
        - '1.1.7'
        - '1.1.8'
        - '1.1.9'
      level: 1

service:
  autofs:
    enabled: false
    running: false
    title: '1.1.23 Disable Automounting'
    meta:
      item:
        - '1.1.23'
      level: 1

  {{- if eq .Vars.fsIntegrityTool "osquery"}}
  {{.Vars.fsIntegrityTool}}d:
    enabled: true
    running: true
    title: '1.3.2 Ensure filesystem integrity is regularly checked'
    meta:
      item:
        - '1.3.2'
      level: 1
  {{- else if eq .Vars.fsIntegrityTool "aide"}}
  {{.Vars.fsIntegrityTool}}check:
    enabled: true
    running: true
    title: '1.3.2 Ensure filesystem integrity is regularly checked'
    meta:
      item:
        - '1.3.2'
      level: 1
  {{end}}

package:
  {{.Vars.fsIntegrityTool}}:
    installed: true
    title: '1.3.1 Ensure {{.Vars.fsIntegrityTool}} is installed'
    meta:
      item:
        - '1.3.1'
      level: 1

  prelink:
    installed: false
    title: '1.5.3 Ensure prelink is not installed'
    meta:
      item:
        - '1.5.3'
      level: 1

  apparmor:
    installed: true
    title: '1.6.1.1 Ensure AppArmor is installed'
    meta:
      item:
        - '1.6.1.1'
      level: 1

  gdm3:
    installed: false
    title: '1.8.1 Ensure gdm3 is not installed'
    meta:
      item:
        - '1.8.1'
      level: 2

file:
  {{.Vars.grubConfigFile}}:
    exists: true
    filetype: file
    owner: root
    group: root
    mode: "0400"
    title: '1.4.1 & 1.4.3 Ensure permissions on bootloader config are configured'
    meta:
      item:
        - '1.4.1'
        - '1.4.3'
      level: 1

  /etc/motd:
    exists: {{.Vars.checkMotd}}
    mode: "0644"
    owner: root
    group: root
    contains:
      - "Authorized uses only. All activity may be monitored and reported."
    title: '1.7.1.1 & 1.7.1.4 Ensure message of the day is configured properly'
    meta:
      item:
        - '1.7.1.1'
        - '1.7.1.4'
      level: 1

  /etc/issue:
    exists: true
    mode: "0644"
    owner: root
    group: root
    contains:
      - "Authorized uses only. All activity may be monitored and reported."
    title: '1.7.1.2 & 1.7.1.5 Ensure local login warning banner is configured properly'
    meta:
      item:
        - '1.7.1.2'
        - '1.7.1.5'
      level: 1

  /etc/issue.net:
    exists: true
    mode: "0644"
    owner: root
    group: root
    contains:
      - "Authorized uses only. All activity may be monitored and reported."
    title: '1.7.1.3 & 1.7.1.6 Ensure remote login warning banner is configured properly'
    meta:
      item:
        - '1.7.1.3'
        - '1.7.1.6'
      level: 1

kernel-param:
  kernel.randomize_va_space:
    value: "2"
    title: '1.5.2 Ensure address space layout randomization (ASLR) is enabled'
    meta:
      item:
        - '1.5.2'
      level: 1

  fs.suid_dumpable:
    value:
      match-regexp: 2|0
    title: '1.5.4 Ensure core dumps are restricted'
    meta:
      item:
        - '1.5.4'
      level: 1

  kernel.core_pattern:
    value:
      match-regexp: core|\|/usr/share/apport/apport %p %s %c %d %P %E
    title: '1.5.4 Ensure core dumps are restricted'
    meta:
      item:
        - '1.5.4'
      level: 1
