---
# CIS Ubuntu Linux 20.04 LTS Benchmark v1.1.0
#
# 2 Services

package:
  {{.Vars.timeSyncPackage}}:
    installed: true
    title: "2.1.1.1 Ensure time synchronization is in use"
    meta:
      item:
        - "2.1.1.1"
      level: 1

  xserver-xorg*:
    installed: false
    title: "2.1.2 Ensure X Window System is not installed"
    meta:
      item:
        - "2.1.2"
      level: 1

  {{- range $k, $v := dict "avahi-daemon" "2.1.3" "cups" "2.1.4" "isc-dhcp-server" "2.1.5" "slapd" "2.1.6" "nfs-kernel-server" "2.1.7" "bind9" "2.1.8"}}
  {{$k}}:
    installed: false
    title: "{{$v}} Ensure {{$k}} is not installed"
    meta:
      item:
        - "{{$v}}"
      level: 1
  {{end}}

  {{- range $k, $v := dict "vsfptd" "2.1.9" "apache2" "2.1.10" "dovecot-*" "2.1.11" "samba" "2.1.12" "squid" "2.1.13" "snmpd" "2.1.14" "rsync" "2.1.16"}}
  {{$k}}:
    installed: false
    title: "{{$v}} Ensure {{$k}} is not installed"
    meta:
      item:
        - "{{$v}}"
      level: 1
  {{end}}

  {{- range $k, $v := dict "nis" "2.2.1" "rsh-client" "2.2.2" "talk" "2.2.3" "telnet" "2.2.4" "ldap-utils" "2.2.5" "rpcbind" "2.2.6"}}
  {{$k}}:
    installed: false
    title: "{{$v}} Ensure {{$k}} is not installed"
    meta:
      item:
        - "{{$v}}"
      level: 1
  {{end}}

  {{- range list "xinetd" "openbsd-inetd"}}
  {{.}}:
    installed: false
    title: "2.3 Ensure nonessential services are removed or masked"
    meta:
      item:
        - "2.3"
      level: 1
  {{end}}

service:
  systemd-timesyncd:
    enabled: {{eq .Vars.timeSyncPackage "systemd-timesyncd"}}
    running: {{eq .Vars.timeSyncPackage "systemd-timesyncd"}}
    title: "2.1.1.2 Ensure systemd-timesyncd is configured"
    meta:
      item:
        - "2.1.1.2"
      level: 1

  chronyd:
    enabled: {{eq .Vars.timeSyncPackage "chrony"}}
    running: {{eq .Vars.timeSyncPackage "chrony"}}
    title: "2.1.1.3 Ensure chrony is configured"
    meta:
      item:
        - "2.1.1.3"
      level: 1

  ntpd:
    enabled: {{eq .Vars.timeSyncPackage "ntp"}}
    running: {{eq .Vars.timeSyncPackage "ntp"}}
    title: "2.1.1.4 Ensure ntp is configured"
    meta:
      item:
        - "2.1.1.4"
      level: 1

command:
  timedatectl show --property NTP --property NTPSynchronized:
    exit-status: 0
    stdout:
      - NTP=yes
      - NTPSynchronized=yes
    skip: {{ne .Vars.timeSyncPackage "systemd-timesyncd"}}
    title: "2.1.1.2 Ensure systemd-timesyncd is configured"
    meta:
      item:
        - "2.1.1.2"
      level: 1

  ss -lntu | grep -E ':25\s' | grep -E -v '\s(127.0.0.1|::1):25\s':
    exit-status: 1
    stdout: []
    title: "2.1.15 Ensure mail transfer agent is configured for local-only mode"
    meta:
      item:
        - "2.1.15"
      level: 1